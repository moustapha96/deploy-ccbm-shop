var O=Object.defineProperty,S=Object.defineProperties;var I=Object.getOwnPropertyDescriptors;var L=Object.getOwnPropertySymbols;var A=Object.prototype.hasOwnProperty,M=Object.prototype.propertyIsEnumerable;var C=(t,s,n)=>s in t?O(t,s,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[s]=n,x=(t,s)=>{for(var n in s||(s={}))A.call(s,n)&&C(t,n,s[n]);if(L)for(var n of L(s))M.call(s,n)&&C(t,n,s[n]);return t},p=(t,s)=>S(t,I(s));var y=(t,s,n)=>new Promise((h,i)=>{var d=l=>{try{u(n.next(l))}catch(b){i(b)}},v=l=>{try{u(n.throw(l))}catch(b){i(b)}},u=l=>l.done?h(l.value):Promise.resolve(l.value).then(d,v);u((n=n.apply(t,s)).next())});import{u as q,B,j as e,m as U,A as V,p as $,L as G,t as T,f as F}from"./index-BJ2Ssq_J.js";import{u as Y,c as z,b as m,L as H}from"./vendor-KAqkdx26.js";import{P as N}from"./paimentService-DInxGFTk.js";const f={COMPLETED:"completed",PENDING:"pending",CANCELLED:"cancelled"},D={ORDER:"order",PREORDER:"preorder",CREDITORDER:"creditorder"},J={[D.ORDER]:t=>`/commandes/${t}/détails`,[D.PREORDER]:t=>`/pre-commandes/${t}/détails`,[D.CREDITORDER]:t=>`/credit-commandes/${t}/détails`};function le({cart:t=!0}){const{user:s}=q(),n=Y(),h=z(),[i,d]=m.useState({paymentData:null,isLoading:!1,token:null,error:null}),v=m.useCallback(()=>new URLSearchParams(h.search).get("token"),[h.search]),u=m.useCallback((r,a)=>{const c=J[r];c?n(c(a)):(console.error(`Unknown order type: ${r}`),n("/profile"))},[n]),l=m.useCallback((r,a)=>{B[r](a,{position:"top-right",autoClose:5e3})},[]),b=m.useCallback(r=>y(null,null,function*(){const{status:a,order_type:c,order_id:j}=r;switch(a){case f.COMPLETED:u(c,j);break;case f.PENDING:l("warning","Le paiement est en attente");break;case f.CANCELLED:l("error","Le paiement a été annulé");break;default:l("warning","Statut de paiement inconnu")}}),[u,l]),w=m.useCallback((r,a)=>y(null,null,function*(){const{receipt_url:c,customer:j,status:P}=a;try{const o=yield N.putPaymentDetailByToken(r,c,j.name,j.email,j.phone,P);console.log(o),o&&o.type_sale&&u(o.type_sale,o.id),u(o.type_sale,o.id)}catch(o){console.log(o),l("warning",o&&o.response&&o.response.data&&o.response.data.message?o.response.data.message:"Erreur lors de la mise à jour du paiement")}}),[u,l]),E=m.useCallback(r=>y(null,null,function*(){d(a=>p(x({},a),{isLoading:!0,error:null}));try{const a=yield N.confirmInvoice(r);if(d(c=>p(x({},c),{paymentData:a})),a.response_code==="00"&&a.status===f.COMPLETED){const{receipt_url:c,customer:j,status:P}=a;console.log(a.invoice),a.status!==f.COMPLETED?l("warning","Le paiement n'est pas encore validé"):a.status===f.COMPLETED&&l("success","Le paiement est validé"),yield w(r,a)}else a.status===f.CANCELLED?(l("error","Le paiement a été annulé"),yield N.putPaymentDetailByToken(r)):a.status===f.PENDING&&l("warning","Le paiement est en attente")}catch(a){console.error("Error confirming payment:",a),d(c=>p(x({},c),{error:"Erreur lors de la confirmation du paiement"})),l("error","Erreur lors de la confirmation du paiement")}finally{d(a=>p(x({},a),{isLoading:!1}))}}),[w,l]),k=m.useCallback(r=>y(null,null,function*(){try{const a=yield N.getPaymentDetailsByToken(r);a&&a.payment_state&&a.token_status&&(yield b(p(x({},a),{status:a.payment_state,order_type:a.order_type,order_id:a.order_id})))}catch(a){console.error("Error checking payment status:",a)}}),[b]),R=m.useCallback(()=>{i.paymentData&&i.paymentData.receipt_url&&window.open(i.paymentData.receipt_url,"_blank","noopener,noreferrer")},[i.paymentData&&i.paymentData.receipt_url]),_=m.useCallback(()=>y(null,null,function*(){i.token&&(yield E(i.token))}),[i.token,E]);m.useEffect(()=>{const r=v();if(!r){d(c=>p(x({},c),{token:null}));return}d(c=>p(x({},c),{token:r})),k(r);const a=setTimeout(()=>{E(r)},1e3);return()=>clearTimeout(a)},[v,k,E]);const g=[{name:"Accueil",path:"/"},{name:"Tableau de bord",path:"/profile"},{name:"Validation Paiement",path:`/payment-state?token=${i.token}`}];return e.jsx(U,{childrenClasses:t?"pt-0 pb-0":"",children:t?e.jsxs("div",{className:"cart-page-wrapper w-full bg-white pb-[60px]",children:[e.jsx("div",{className:"w-full",children:e.jsx(V,{title:"Statut Paiement",breadcrumb:g})}),i.isLoading&&e.jsx(K,{}),i.paymentData&&e.jsx(Q,{data:i.paymentData,onOpenInvoice:R}),!i.token&&e.jsx(ee,{onVerify:_})]}):e.jsx("div",{className:"cart-page-wrapper w-full",children:e.jsx("div",{className:"container-x mx-auto",children:e.jsx($,{paths:g})})})})}function K(){return e.jsx("div",{className:"flex justify-center items-center w-full h-64",children:e.jsx(G,{size:50,className:"animate-spin text-blue-500"})})}function Q({data:t,onOpenInvoice:s}){return e.jsx("div",{className:"w-full mt-[23px]",children:e.jsx("div",{className:"container-x mx-auto",children:e.jsx("div",{className:"checkout-main-content w-full",children:e.jsx("div",{className:"container-x mx-auto",children:e.jsx("div",{className:"w-full lg:flex lg:space-x-[30px]",children:e.jsxs("div",{className:"flex-1",children:[e.jsx("h1",{className:"sm:text-2xl text-xl text-qblack font-medium mb-5",children:"Récapitulatif paiement"}),e.jsxs("div",{className:"w-full px-10 py-[30px] border border-[#EDEDED] rounded-lg",children:[e.jsx(W,{}),e.jsx(X,{data:t,onOpenInvoice:s})]})]})})})})})})}function W(){return e.jsxs("div",{className:"sub-total mb-6",children:[e.jsx("div",{className:"flex justify-between mb-5",children:e.jsx("p",{className:"text-[13px] font-medium text-qblack uppercase",children:"Détails Paiement"})}),e.jsx("div",{className:"w-full h-[1px] bg-[#EDEDED]"})]})}function X({data:t,onOpenInvoice:s}){const n=[{label:"Prénom & Nom",value:t.customer.name},{label:"Téléphone",value:t.customer.phone},{label:"Email",value:t.customer.email},{label:"Montant Payé",value:F(t.invoice.total_amount)}];return e.jsxs("div",{className:"product-list w-full mb-[30px]",children:[e.jsxs("ul",{className:"flex flex-col space-y-5",children:[n.map((h,i)=>e.jsx(Z,{label:h.label,value:h.value},i)),e.jsx("li",{children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{children:e.jsx("h4",{className:"text-[15px] text-qblack mb-2.5",children:"Facture"})}),e.jsx("div",{children:e.jsx("button",{className:"text-[15px] text-blue-600 font-medium underline hover:text-blue-800 transition-colors",onClick:s,children:"Ouvrir la facture"})})]})})]}),e.jsx("div",{className:"w-full h-[1px] bg-[#EDEDED] mt-6"})]})}function Z({label:t,value:s}){return e.jsx("li",{children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{children:e.jsx("h4",{className:"text-[15px] text-qblack mb-2.5",children:t})}),e.jsx("div",{children:e.jsx("span",{className:"text-[15px] text-qblack font-medium",children:s})})]})})}function ee({onVerify:t}){return e.jsx("div",{className:"checkout-main-content w-full",children:e.jsx("div",{className:"container-x mx-auto",children:e.jsx("div",{className:"w-full sm:mb-10 mb-5",children:e.jsx("div",{className:"sm:flex sm:space-x-[18px]",children:e.jsxs("div",{className:"flex-1 w-full mb-5 space-y-4",children:[e.jsx("div",{className:"w-full h-[70px] bg-red-50 border border-red-200 text-red-800 flex justify-center items-center rounded-lg",children:e.jsx("span",{className:"text-[15px] font-medium",children:"Token Non Valide"})}),e.jsx(H,{to:"/boutique",className:"block",children:e.jsx(T,{className:"w-full rounded-lg px-5 py-2.5 font-medium text-xl hover:bg-blue-600 transition-colors",children:"Retour à la boutique"})}),e.jsx(T,{color:"yellow",onClick:t,className:"w-full rounded-lg px-5 py-2.5 font-medium text-xl hover:bg-yellow-500 transition-colors",children:"Vérifier le paiement"})]})})})})})}export{le as default};
