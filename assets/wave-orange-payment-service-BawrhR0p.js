var j=(u,a,p)=>new Promise((s,c)=>{var v=i=>{try{y(p.next(i))}catch(w){c(w)}},b=i=>{try{y(p.throw(i))}catch(w){c(w)}},y=i=>i.done?s(i.value):Promise.resolve(i.value).then(v,b);y((p=p.apply(u,a)).next())});import{x as ce,u as me,j as e,M,y as de,f as k,t as C,n as q,J as B,B as x,z as ue,K as $}from"./index-BJ2Ssq_J.js";import{b as l,u as xe}from"./vendor-KAqkdx26.js";const pe="/assets/wave-image-DnO_I3CT.png",he="/assets/om-image-CBEzpwAR.png",fe=["70","75","76","77","78"],D=u=>{if(!u)return"";let a=String(u).replace(/[^\d]+/g,"");return a.startsWith("00221")?a=a.slice(5):a.startsWith("221")?a=a.slice(3):a.startsWith("0")&&(a=a.slice(1)),a.length===9&&fe.includes(a.slice(0,2))?`221${a}`:(a.length===12&&a.startsWith("221"),a)},ge=u=>/^221(70|75|76|77|78)\d{7}$/.test(u),ye=(u="REF")=>`${u}-${Date.now()}-${Math.random().toString(36).slice(2,8).toUpperCase()}`,je=(u,a,p,s,c)=>[u,a,p,s,c,Date.now()].filter(Boolean).join("-"),ve=()=>typeof navigator!="undefined"&&/Android|iPhone|iPad|iPod|IEMobile|Opera Mini/i.test(navigator.userAgent),Pe=({handlePay:u,totalAmount:a,onClose:p,order:s,idOrder:c})=>{l.useEffect(()=>{localStorage.setItem("idOrderPayment",""),localStorage.setItem("montant",""),localStorage.setItem("tokenOrderPayment",""),localStorage.setItem("statusOrderPayment",""),localStorage.setItem("idDataPayment",""),localStorage.setItem("mm_transaction_id",""),localStorage.setItem("mm_method","")},[]);const v=xe(),{setUserPayment:b,setOrder:y}=l.useContext(ce),{user:i,token:w}=me(),[N,_]=l.useState(!1),[Q,R]=l.useState(!0),[n,z]=l.useState(""),[P,A]=l.useState(""),[X,H]=l.useState(!1),[J,K]=l.useState(""),[G,Y]=l.useState(""),[E,F]=l.useState(!1),[T,Z]=l.useState(null),[U,ee]=l.useState(null),[W,te]=l.useState(null),f=l.useRef(null),g=l.useRef(null);l.useEffect(()=>{b&&b(i),y&&y(s)},[]),l.useEffect(()=>()=>{f.current&&clearInterval(f.current),g.current&&clearTimeout(g.current)},[]);const se=r=>ge(D(r)),ae=r=>j(null,null,function*(){if(r.preventDefault(),!n){x.error("Veuillez sélectionner une méthode de paiement",{position:"top-center",autoClose:3e3});return}if(!P){x.error("Veuillez entrer votre numéro de téléphone",{position:"top-center",autoClose:3e3});return}const h=D(P);if(!se(h)){x.error("Numéro invalide. Utilisez 77/78/76/75/70 au format 221771234567",{position:"top-center",autoClose:4e3});return}_(!0);try{ue(c,a,(s&&s.order_lines||[]).map(m=>({name:m.product_name,price:m.price_unit,quantity:m.product_uom_qty})));const t=je(i&&i.id,c,Math.ceil(a),s&&s.name,s&&s.type_sale),d=ye(n==="wave"?"WAV":"OM");K(d);const oe=n==="wave"?`${window.location.origin}/wave-paiement?transaction=${encodeURIComponent(t)}`:`${window.location.origin}/om-paiement?transaction=${encodeURIComponent(t)}`,o=yield $.initiatePayment(n,{transaction_id:t,order_id:c,partner_id:i&&i.id,phoneNumber:h,amount:Math.ceil(a),description:`${s&&s.name||"Commande"} - ${c}`,reference:d,success_url:oe}),be={transaction_id:t,amount:Math.ceil(a),order_id:c,order_type:s&&s.type_sale,order_name:s&&s.name,partner_id:i&&i.id,payment_token:d,payment_state:"pending",payment_method:n,customer_phone:h,provider_status:o&&o.status||"pending"};localStorage.setItem("idOrderPayment",String(c)),localStorage.setItem("montant",String(Math.ceil(a))),localStorage.setItem("tokenOrderPayment",d),localStorage.setItem("statusOrderPayment","pending"),localStorage.setItem("mm_transaction_id",t),localStorage.setItem("mm_method",n),Y(t),H(!0);const L=ve();if(n==="orange"){const m=o&&o.qr_code_base64,I=o&&o.deep_link_maxit||o&&o.deep_link||o&&o.short_link;if(L&&I)ee(I),window.location.href=I;else if(m){const ie=m.startsWith("data:image")?m:`data:image/png;base64,${m}`;Z(ie)}}if(n==="wave"){const m=o&&o.payment_url||o&&o.deep_link||o&&o.short_link;m&&(te(m),L?window.location.href=m:window.open(m,"_blank","noopener,noreferrer"))}x.success(`Demande envoyée via ${n==="wave"?"Wave":"Orange Money"}. Validez sur votre téléphone.`,{position:"top-center",autoClose:5e3}),ne(t,n)}catch(t){console.error(t),x.error(`Erreur lors du paiement: ${t&&t.message||"échec inconnu"}`,{position:"top-center",autoClose:5e3})}finally{_(!1)}}),ne=(r,h)=>{f.current&&clearInterval(f.current),g.current&&clearTimeout(g.current),F(!0),f.current=setInterval(()=>j(null,null,function*(){try{const t=yield $.verifyPayment(h,r),d=String(t&&t.status||t&&t.transaction&&t.transaction.status||"").toLowerCase();["completed","success","succeeded"].includes(d)?yield O():["failed","canceled","cancelled","rejected","expired"].includes(d)&&(yield V(t&&t.reason||`Paiement ${d}`))}catch(t){console.warn("Polling error:",t&&t.message)}}),4e3),g.current=setTimeout(()=>{S(),x.info("Toujours en attente de confirmation… Vous pouvez relancer la vérification.",{position:"top-center"})},12e4)},S=()=>{f.current&&clearInterval(f.current),g.current&&clearTimeout(g.current),f.current=null,g.current=null,F(!1)},O=()=>j(null,null,function*(){S();try{x.success("Paiement confirmé avec succès !",{position:"top-center",autoClose:3e3}),(s&&s.type_sale)==="preorder"?v(`/pre-commandes/${c}/détails`):(s&&s.type_sale)==="creditorder"?v(`/credit-commandes/${c}/détails`):v(`/commandes/${c}/détails`),R(!1)}catch(r){console.error(r),x.error("Paiement reçu mais échec de mise à jour locale.",{position:"top-center"})}}),V=r=>j(null,null,function*(){S(),x.error(`Paiement échoué: ${r||"Refusé par l'opérateur"}`,{position:"top-center",autoClose:5e3})}),re=()=>j(null,null,function*(){const r=G||localStorage.getItem("mm_transaction_id"),h=n||localStorage.getItem("mm_method");if(!(!r||!h)){_(!0);try{const t=yield $.verifyPayment(h,r),d=String(t&&t.status||t&&t.transaction&&t.transaction.status||"").toLowerCase();["completed","success","succeeded"].includes(d)?yield O():["failed","canceled","cancelled","rejected","expired"].includes(d)?yield V(t&&t.reason||`Paiement ${d}`):x.warning("Toujours en attente de validation sur votre téléphone.",{position:"top-center",autoClose:4e3})}catch(t){x.error(`Erreur lors de la vérification: ${t&&t.message||"inconnue"}`,{position:"top-center",autoClose:5e3})}finally{_(!1)}}}),le=()=>{S(),R(!1),p&&p()};return e.jsxs(M,{size:"xl",className:"h-auto",show:Q,popup:!0,onClose:p,children:[e.jsx(M.Header,{}),e.jsx(M.Body,{children:e.jsx("div",{className:"fixed inset-0 p-4 flex flex-wrap justify-center items-center w-full h-full z-[1000] before:fixed before:inset-0 before:w-full before:h-full before:bg-[rgba(0,0,0,0.5)] overflow-auto font-[sans-serif]",children:e.jsxs("div",{className:"w-full max-w-lg bg-white shadow-lg rounded-lg p-8 relative",children:[e.jsxs("div",{className:"flex items-start border-b border-gray-300 pb-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("h3",{className:"text-gray-800 text-xl font-bold",children:["Paiement"," ",(s&&s.type_sale)==="order"?"Commande":(s&&s.type_sale)==="preorder"?"Pré-Commande":"Commande à crédit"]}),e.jsx("p",{className:"text-gray-600 text-sm mt-1",children:"Résumé détaillé de votre commande."})]}),e.jsx("p",{children:e.jsx(de,{onClick:le,className:"cursor-pointer hover:text-red-500 hover:scale-150 duration-300"})})]}),s&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"my-8",children:[e.jsx("table",{className:"w-full",children:e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left text-gray-800 text-sm py-2",children:"Nom de la commande :"}),e.jsx("th",{className:"text-right text-gray-800 text-sm py-2",children:s.name})]})})}),e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left text-gray-800 text-sm py-2",children:"Nom produit"}),e.jsx("th",{className:"text-right text-gray-800 text-sm py-2",children:"Prix total"})]})}),e.jsx("tbody",{children:(s.order_lines||[]).map((r,h)=>e.jsxs("tr",{children:[e.jsxs("td",{className:"text-left text-gray-800 text-sm py-2",children:[r.product_name," (",r.product_uom_qty,")"]}),e.jsx("td",{className:"text-right text-gray-800 text-sm py-2 font-medium",children:k(r.price_total)})]},h))})]}),e.jsx("table",{className:"w-full",children:e.jsxs("thead",{children:[e.jsxs("tr",{children:[e.jsx("th",{className:"text-left text-gray-800 text-sm py-2",children:"Total Commande (FCFA) :"}),e.jsx("th",{className:"text-right text-gray-800 text-sm py-2",children:k(Math.ceil(s.amount_total))})]}),e.jsxs("tr",{children:[e.jsx("th",{className:"text-left text-gray-800 text-sm py-2",children:"Montant à payer (FCFA) :"}),e.jsx("th",{className:"text-right text-gray-800 text-sm py-2",children:k(Math.ceil(a))})]})]})}),X?e.jsxs("div",{className:"mt-6 space-y-6",children:[e.jsxs("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4",children:[e.jsx("h4",{className:"text-yellow-800 font-medium mb-2",children:"Paiement en attente"}),e.jsx("p",{className:"text-yellow-700 text-sm",children:"Vérifiez votre téléphone et confirmez le paiement."}),e.jsxs("p",{className:"text-yellow-700 text-sm mt-2",children:["Référence: ",e.jsx("span",{className:"font-medium",children:J})]})]}),n==="orange"&&e.jsxs(e.Fragment,{children:[T&&e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("img",{src:T,alt:"QR Orange Money",className:"w-60 h-60 object-contain border rounded-lg"}),e.jsx("p",{className:"text-xs text-gray-500 mt-2 text-center",children:"Scannez ce QR dans l’app Orange Money pour finaliser."})]}),U&&e.jsxs(C,{onClick:()=>window.location.href=U,pill:!0,className:"rounded-lg px-5 py-2.5 font-medium w-full bg-orange-600 hover:bg-orange-700 text-white",children:["Ouvrir Orange Money ",e.jsx(B,{className:"ml-2 inline h-4 w-4"})]})]}),n==="wave"&&W&&e.jsxs(C,{onClick:()=>window.location.href=W,pill:!0,className:"rounded-lg px-5 py-2.5 font-medium w-full bg-blue-600 hover:bg-blue-700 text-white",children:["Ouvrir Wave ",e.jsx(B,{className:"ml-2 inline h-4 w-4"})]}),e.jsx("div",{className:"flex max-sm:flex-col items-center gap-4",children:e.jsx(C,{onClick:re,disabled:N||E,pill:!0,className:"rounded-lg px-5 py-2.5 font-medium w-full bg-green-600 hover:bg-green-700 text-white text-xl",children:N?e.jsxs(e.Fragment,{children:[e.jsx(q,{className:"mr-2 h-4 w-4 animate-spin"}),e.jsx("p",{children:"Vérification..."})]}):E?"Vérification automatique en cours…":"Vérifier le paiement"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mt-6 mb-4",children:[e.jsx("h4",{className:"text-gray-800 font-medium mb-3",children:"Choisissez votre méthode de paiement"}),e.jsxs("div",{className:"flex space-x-4",children:[e.jsx("div",{className:`flex-1 border rounded-lg p-4 cursor-pointer transition-all ${n==="wave"?"border-blue-500 bg-blue-50":"border-gray-300 hover:border-blue-300"}`,onClick:()=>z("wave"),children:e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx("img",{src:pe,width:100,alt:""})})}),e.jsx("div",{className:`flex-1 border rounded-lg p-4 cursor-pointer transition-all ${n==="orange"?"border-orange-500 bg-orange-50":"border-gray-300 hover:border-orange-300"}`,onClick:()=>z("orange"),children:e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx("img",{src:he,width:100,alt:""})})})]})]}),n&&e.jsxs("div",{className:"mt-4 mb-6",children:[e.jsxs("label",{htmlFor:"phone",className:"block text-sm font-medium text-gray-700 mb-1",children:["Numéro ",n==="wave"?"Wave":"Orange Money"]}),e.jsx("input",{type:"tel",id:"phone",value:P,onChange:r=>A(r.target.value),placeholder:"77 123 45 67",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Utilisez un numéro sénégalais (ex: 221771234567). 77/78/76/75/70 acceptés."})]}),e.jsx("div",{className:"flex max-sm:flex-col items-center gap-4 mt-8",children:e.jsx(C,{onClick:ae,disabled:N||!n||!P,pill:!0,className:"rounded-lg px-5 !bg-[#487a43]  py-2.5 font-medium w-full hover:bg-red-500 hover:text-white text-xl",children:N?e.jsxs(e.Fragment,{children:[e.jsx(q,{className:"mr-2 h-4 w-4 animate-spin"}),e.jsx("p",{children:"Traitement en cours..."})]}):"Payer maintenant"})})]})]})})]})})})]})};export{Pe as W};
