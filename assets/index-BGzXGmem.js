import{u as R,B as _,j as e,l as O,A as S,o as I,L as A,s as L,f as M}from"./index-Btdq7Gn8.js";import{u as q,c as B,b as c,L as U}from"./vendor-Cppah_1b.js";import{P as b}from"./paimentService-Ba096akK.js";const o={COMPLETED:"completed",PENDING:"pending",CANCELLED:"cancelled"},j={ORDER:"order",PREORDER:"preorder",CREDITORDER:"creditorder"},V={[j.ORDER]:s=>`/commandes/${s}/détails`,[j.PREORDER]:s=>`/pre-commandes/${s}/détails`,[j.CREDITORDER]:s=>`/credit-commandes/${s}/détails`};function W({cart:s=!0}){var w;const{user:m}=R(),x=q(),p=B(),[r,u]=c.useState({paymentData:null,isLoading:!1,token:null,error:null}),y=c.useCallback(()=>new URLSearchParams(p.search).get("token"),[p.search]),f=c.useCallback((t,a)=>{const n=V[t];n?x(n(a)):(console.error(`Unknown order type: ${t}`),x("/profile"))},[x]),i=c.useCallback((t,a)=>{_[t](a,{position:"top-right",autoClose:5e3})},[]),v=c.useCallback(async t=>{const{status:a,order_type:n,order_id:d}=t;switch(a){case o.COMPLETED:f(n,d);break;case o.PENDING:i("warning","Le paiement est en attente");break;case o.CANCELLED:i("error","Le paiement a été annulé");break;default:i("warning","Statut de paiement inconnu")}},[f,i]),E=c.useCallback(async(t,a)=>{var g,P;const{receipt_url:n,customer:d,status:k}=a;try{const l=await b.putPaymentDetailByToken(t,n,d.name,d.email,d.phone,k);console.log(l),l!=null&&l.type_sale&&f(l.type_sale,l.id),f(l.type_sale,l.id)}catch(l){console.log(l),i("warning",(P=(g=l==null?void 0:l.response)==null?void 0:g.data)!=null&&P.message?l.response.data.message:"Erreur lors de la mise à jour du paiement")}},[f,i]),h=c.useCallback(async t=>{u(a=>({...a,isLoading:!0,error:null}));try{const a=await b.confirmInvoice(t);if(u(n=>({...n,paymentData:a})),a.response_code==="00"&&a.status===o.COMPLETED){const{receipt_url:n,customer:d,status:k}=a;console.log(a.invoice),a.status!==o.COMPLETED?i("warning","Le paiement n'est pas encore validé"):a.status===o.COMPLETED&&i("success","Le paiement est validé"),await E(t,a)}else a.status===o.CANCELLED?(i("error","Le paiement a été annulé"),await b.putPaymentDetailByToken(t)):a.status===o.PENDING&&i("warning","Le paiement est en attente")}catch(a){console.error("Error confirming payment:",a),u(n=>({...n,error:"Erreur lors de la confirmation du paiement"})),i("error","Erreur lors de la confirmation du paiement")}finally{u(a=>({...a,isLoading:!1}))}},[E,i]),N=c.useCallback(async t=>{try{const a=await b.getPaymentDetailsByToken(t);a!=null&&a.payment_state&&a.token_status&&await v({...a,status:a.payment_state,order_type:a.order_type,order_id:a.order_id})}catch(a){console.error("Error checking payment status:",a)}},[v]),C=c.useCallback(()=>{var t;(t=r.paymentData)!=null&&t.receipt_url&&window.open(r.paymentData.receipt_url,"_blank","noopener,noreferrer")},[(w=r.paymentData)==null?void 0:w.receipt_url]),T=c.useCallback(async()=>{r.token&&await h(r.token)},[r.token,h]);c.useEffect(()=>{const t=y();if(!t){u(n=>({...n,token:null}));return}u(n=>({...n,token:t})),N(t);const a=setTimeout(()=>{h(t)},1e3);return()=>clearTimeout(a)},[y,N,h]);const D=[{name:"Accueil",path:"/"},{name:"Tableau de bord",path:"/profile"},{name:"Validation Paiement",path:`/payment-state?token=${r.token}`}];return e.jsx(O,{childrenClasses:s?"pt-0 pb-0":"",children:s?e.jsxs("div",{className:"cart-page-wrapper w-full bg-white pb-[60px]",children:[e.jsx("div",{className:"w-full",children:e.jsx(S,{title:"Statut Paiement",breadcrumb:D})}),r.isLoading&&e.jsx($,{}),r.paymentData&&e.jsx(G,{data:r.paymentData,onOpenInvoice:C}),!r.token&&e.jsx(H,{onVerify:T})]}):e.jsx("div",{className:"cart-page-wrapper w-full",children:e.jsx("div",{className:"container-x mx-auto",children:e.jsx(I,{paths:D})})})})}function $(){return e.jsx("div",{className:"flex justify-center items-center w-full h-64",children:e.jsx(A,{size:50,className:"animate-spin text-blue-500"})})}function G({data:s,onOpenInvoice:m}){return e.jsx("div",{className:"w-full mt-[23px]",children:e.jsx("div",{className:"container-x mx-auto",children:e.jsx("div",{className:"checkout-main-content w-full",children:e.jsx("div",{className:"container-x mx-auto",children:e.jsx("div",{className:"w-full lg:flex lg:space-x-[30px]",children:e.jsxs("div",{className:"flex-1",children:[e.jsx("h1",{className:"sm:text-2xl text-xl text-qblack font-medium mb-5",children:"Récapitulatif paiement"}),e.jsxs("div",{className:"w-full px-10 py-[30px] border border-[#EDEDED] rounded-lg",children:[e.jsx(F,{}),e.jsx(Y,{data:s,onOpenInvoice:m})]})]})})})})})})}function F(){return e.jsxs("div",{className:"sub-total mb-6",children:[e.jsx("div",{className:"flex justify-between mb-5",children:e.jsx("p",{className:"text-[13px] font-medium text-qblack uppercase",children:"Détails Paiement"})}),e.jsx("div",{className:"w-full h-[1px] bg-[#EDEDED]"})]})}function Y({data:s,onOpenInvoice:m}){const x=[{label:"Prénom & Nom",value:s.customer.name},{label:"Téléphone",value:s.customer.phone},{label:"Email",value:s.customer.email},{label:"Montant Payé",value:M(s.invoice.total_amount)}];return e.jsxs("div",{className:"product-list w-full mb-[30px]",children:[e.jsxs("ul",{className:"flex flex-col space-y-5",children:[x.map((p,r)=>e.jsx(z,{label:p.label,value:p.value},r)),e.jsx("li",{children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{children:e.jsx("h4",{className:"text-[15px] text-qblack mb-2.5",children:"Facture"})}),e.jsx("div",{children:e.jsx("button",{className:"text-[15px] text-blue-600 font-medium underline hover:text-blue-800 transition-colors",onClick:m,children:"Ouvrir la facture"})})]})})]}),e.jsx("div",{className:"w-full h-[1px] bg-[#EDEDED] mt-6"})]})}function z({label:s,value:m}){return e.jsx("li",{children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{children:e.jsx("h4",{className:"text-[15px] text-qblack mb-2.5",children:s})}),e.jsx("div",{children:e.jsx("span",{className:"text-[15px] text-qblack font-medium",children:m})})]})})}function H({onVerify:s}){return e.jsx("div",{className:"checkout-main-content w-full",children:e.jsx("div",{className:"container-x mx-auto",children:e.jsx("div",{className:"w-full sm:mb-10 mb-5",children:e.jsx("div",{className:"sm:flex sm:space-x-[18px]",children:e.jsxs("div",{className:"flex-1 w-full mb-5 space-y-4",children:[e.jsx("div",{className:"w-full h-[70px] bg-red-50 border border-red-200 text-red-800 flex justify-center items-center rounded-lg",children:e.jsx("span",{className:"text-[15px] font-medium",children:"Token Non Valide"})}),e.jsx(U,{to:"/boutique",className:"block",children:e.jsx(L,{className:"w-full rounded-lg px-5 py-2.5 font-medium text-xl hover:bg-blue-600 transition-colors",children:"Retour à la boutique"})}),e.jsx(L,{color:"yellow",onClick:s,className:"w-full rounded-lg px-5 py-2.5 font-medium text-xl hover:bg-yellow-500 transition-colors",children:"Vérifier le paiement"})]})})})})})}export{W as default};
