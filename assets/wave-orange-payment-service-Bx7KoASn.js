import{x as oe,u as ie,j as e,M as I,y as ce,f as M,s as N,m as q,I as B,B as d,z as me,J as k}from"./index-DwDdeQn7.js";import{b as i,u as de}from"./vendor-Cppah_1b.js";const ue="/assets/wave-image-DnO_I3CT.png",xe="/assets/om-image-CBEzpwAR.png",pe=["70","75","76","77","78"],D=p=>{if(!p)return"";let s=String(p).replace(/[^\d]+/g,"");return s.startsWith("00221")?s=s.slice(5):s.startsWith("221")?s=s.slice(3):s.startsWith("0")&&(s=s.slice(1)),s.length===9&&pe.includes(s.slice(0,2))?`221${s}`:(s.length===12&&s.startsWith("221"),s)},he=p=>/^221(70|75|76|77|78)\d{7}$/.test(p),fe=(p="REF")=>`${p}-${Date.now()}-${Math.random().toString(36).slice(2,8).toUpperCase()}`,ge=(p,s,y,t,m)=>[p,s,y,t,m,Date.now()].filter(Boolean).join("-"),ye=()=>typeof navigator!="undefined"&&/Android|iPhone|iPad|iPod|IEMobile|Opera Mini/i.test(navigator.userAgent),Ne=({handlePay:p,totalAmount:s,onClose:y,order:t,idOrder:m})=>{i.useEffect(()=>{localStorage.setItem("idOrderPayment",""),localStorage.setItem("montant",""),localStorage.setItem("tokenOrderPayment",""),localStorage.setItem("statusOrderPayment",""),localStorage.setItem("idDataPayment",""),localStorage.setItem("mm_transaction_id",""),localStorage.setItem("mm_method","")},[]);const _=de(),{setUserPayment:P,setOrder:S}=i.useContext(oe),{user:u,token:je}=ie(),[j,v]=i.useState(!1),[Q,$]=i.useState(!0),[l,z]=i.useState(""),[w,R]=i.useState(""),[A,X]=i.useState(!1),[H,J]=i.useState(""),[G,K]=i.useState(""),[E,F]=i.useState(!1),[T,Y]=i.useState(null),[W,Z]=i.useState(null),[V,ee]=i.useState(null),f=i.useRef(null),g=i.useRef(null);i.useEffect(()=>{P==null||P(u),S==null||S(t)},[]),i.useEffect(()=>()=>{f.current&&clearInterval(f.current),g.current&&clearTimeout(g.current)},[]);const te=r=>he(D(r)),ae=async r=>{if(r.preventDefault(),!l){d.error("Veuillez sélectionner une méthode de paiement",{position:"top-center",autoClose:3e3});return}if(!w){d.error("Veuillez entrer votre numéro de téléphone",{position:"top-center",autoClose:3e3});return}const x=D(w);if(!te(x)){d.error("Numéro invalide. Utilisez 77/78/76/75/70 au format 221771234567",{position:"top-center",autoClose:4e3});return}v(!0);try{me(m,s,((t==null?void 0:t.order_lines)||[]).map(c=>({name:c.product_name,price:c.price_unit,quantity:c.product_uom_qty})));const o=ge(u==null?void 0:u.id,m,Math.ceil(s),t==null?void 0:t.name,t==null?void 0:t.type_sale),a=fe(l==="wave"?"WAV":"OM");J(a);const h=l==="wave"?`${window.location.origin}/wave-paiement?transaction=${encodeURIComponent(o)}`:`${window.location.origin}/om-paiement?transaction=${encodeURIComponent(o)}`,n=await k.initiatePayment(l,{transaction_id:o,order_id:m,partner_id:u==null?void 0:u.id,phoneNumber:x,amount:Math.ceil(s),description:`${(t==null?void 0:t.name)||"Commande"} - ${m}`,reference:a,success_url:h}),ve={transaction_id:o,amount:Math.ceil(s),order_id:m,order_type:t==null?void 0:t.type_sale,order_name:t==null?void 0:t.name,partner_id:u==null?void 0:u.id,payment_token:a,payment_state:"pending",payment_method:l,customer_phone:x,provider_status:(n==null?void 0:n.status)||"pending"};localStorage.setItem("idOrderPayment",String(m)),localStorage.setItem("montant",String(Math.ceil(s))),localStorage.setItem("tokenOrderPayment",a),localStorage.setItem("statusOrderPayment","pending"),localStorage.setItem("mm_transaction_id",o),localStorage.setItem("mm_method",l),K(o),X(!0);const L=ye();if(l==="orange"){const c=n==null?void 0:n.qr_code_base64,C=(n==null?void 0:n.deep_link_maxit)||(n==null?void 0:n.deep_link)||(n==null?void 0:n.short_link);if(L&&C)Z(C),window.location.href=C;else if(c){const re=c.startsWith("data:image")?c:`data:image/png;base64,${c}`;Y(re)}}if(l==="wave"){const c=(n==null?void 0:n.payment_url)||(n==null?void 0:n.deep_link)||(n==null?void 0:n.short_link);c&&(ee(c),L?window.location.href=c:window.open(c,"_blank","noopener,noreferrer"))}d.success(`Demande envoyée via ${l==="wave"?"Wave":"Orange Money"}. Validez sur votre téléphone.`,{position:"top-center",autoClose:5e3}),se(o,l)}catch(o){console.error(o),d.error(`Erreur lors du paiement: ${(o==null?void 0:o.message)||"échec inconnu"}`,{position:"top-center",autoClose:5e3})}finally{v(!1)}},se=(r,x)=>{f.current&&clearInterval(f.current),g.current&&clearTimeout(g.current),F(!0),f.current=setInterval(async()=>{var o;try{const a=await k.verifyPayment(x,r),h=String((a==null?void 0:a.status)||((o=a==null?void 0:a.transaction)==null?void 0:o.status)||"").toLowerCase();["completed","success","succeeded"].includes(h)?await U():["failed","canceled","cancelled","rejected","expired"].includes(h)&&await O((a==null?void 0:a.reason)||`Paiement ${h}`)}catch(a){console.warn("Polling error:",a==null?void 0:a.message)}},4e3),g.current=setTimeout(()=>{b(),d.info("Toujours en attente de confirmation… Vous pouvez relancer la vérification.",{position:"top-center"})},12e4)},b=()=>{f.current&&clearInterval(f.current),g.current&&clearTimeout(g.current),f.current=null,g.current=null,F(!1)},U=async()=>{b();try{d.success("Paiement confirmé avec succès !",{position:"top-center",autoClose:3e3}),(t==null?void 0:t.type_sale)==="preorder"?_(`/pre-commandes/${m}/détails`):(t==null?void 0:t.type_sale)==="creditorder"?_(`/credit-commandes/${m}/détails`):_(`/commandes/${m}/détails`),$(!1)}catch(r){console.error(r),d.error("Paiement reçu mais échec de mise à jour locale.",{position:"top-center"})}},O=async r=>{b(),d.error(`Paiement échoué: ${r||"Refusé par l'opérateur"}`,{position:"top-center",autoClose:5e3})},ne=async()=>{var o;const r=G||localStorage.getItem("mm_transaction_id"),x=l||localStorage.getItem("mm_method");if(!(!r||!x)){v(!0);try{const a=await k.verifyPayment(x,r),h=String((a==null?void 0:a.status)||((o=a==null?void 0:a.transaction)==null?void 0:o.status)||"").toLowerCase();["completed","success","succeeded"].includes(h)?await U():["failed","canceled","cancelled","rejected","expired"].includes(h)?await O((a==null?void 0:a.reason)||`Paiement ${h}`):d.warning("Toujours en attente de validation sur votre téléphone.",{position:"top-center",autoClose:4e3})}catch(a){d.error(`Erreur lors de la vérification: ${(a==null?void 0:a.message)||"inconnue"}`,{position:"top-center",autoClose:5e3})}finally{v(!1)}}},le=()=>{b(),$(!1),y==null||y()};return e.jsxs(I,{size:"xl",className:"h-auto",show:Q,popup:!0,onClose:y,children:[e.jsx(I.Header,{}),e.jsx(I.Body,{children:e.jsx("div",{className:"fixed inset-0 p-4 flex flex-wrap justify-center items-center w-full h-full z-[1000] before:fixed before:inset-0 before:w-full before:h-full before:bg-[rgba(0,0,0,0.5)] overflow-auto font-[sans-serif]",children:e.jsxs("div",{className:"w-full max-w-lg bg-white shadow-lg rounded-lg p-8 relative",children:[e.jsxs("div",{className:"flex items-start border-b border-gray-300 pb-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("h3",{className:"text-gray-800 text-xl font-bold",children:["Paiement"," ",(t==null?void 0:t.type_sale)==="order"?"Commande":(t==null?void 0:t.type_sale)==="preorder"?"Pré-Commande":"Commande à crédit"]}),e.jsx("p",{className:"text-gray-600 text-sm mt-1",children:"Résumé détaillé de votre commande."})]}),e.jsx("p",{children:e.jsx(ce,{onClick:le,className:"cursor-pointer hover:text-red-500 hover:scale-150 duration-300"})})]}),t&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"my-8",children:[e.jsx("table",{className:"w-full",children:e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left text-gray-800 text-sm py-2",children:"Nom de la commande :"}),e.jsx("th",{className:"text-right text-gray-800 text-sm py-2",children:t.name})]})})}),e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left text-gray-800 text-sm py-2",children:"Nom produit"}),e.jsx("th",{className:"text-right text-gray-800 text-sm py-2",children:"Prix total"})]})}),e.jsx("tbody",{children:(t.order_lines||[]).map((r,x)=>e.jsxs("tr",{children:[e.jsxs("td",{className:"text-left text-gray-800 text-sm py-2",children:[r.product_name," (",r.product_uom_qty,")"]}),e.jsx("td",{className:"text-right text-gray-800 text-sm py-2 font-medium",children:M(r.price_total)})]},x))})]}),e.jsx("table",{className:"w-full",children:e.jsxs("thead",{children:[e.jsxs("tr",{children:[e.jsx("th",{className:"text-left text-gray-800 text-sm py-2",children:"Total Commande (FCFA) :"}),e.jsx("th",{className:"text-right text-gray-800 text-sm py-2",children:M(Math.ceil(t.amount_total))})]}),e.jsxs("tr",{children:[e.jsx("th",{className:"text-left text-gray-800 text-sm py-2",children:"Montant à payer (FCFA) :"}),e.jsx("th",{className:"text-right text-gray-800 text-sm py-2",children:M(Math.ceil(s))})]})]})}),A?e.jsxs("div",{className:"mt-6 space-y-6",children:[e.jsxs("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4",children:[e.jsx("h4",{className:"text-yellow-800 font-medium mb-2",children:"Paiement en attente"}),e.jsx("p",{className:"text-yellow-700 text-sm",children:"Vérifiez votre téléphone et confirmez le paiement."}),e.jsxs("p",{className:"text-yellow-700 text-sm mt-2",children:["Référence: ",e.jsx("span",{className:"font-medium",children:H})]})]}),l==="orange"&&e.jsxs(e.Fragment,{children:[T&&e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("img",{src:T,alt:"QR Orange Money",className:"w-60 h-60 object-contain border rounded-lg"}),e.jsx("p",{className:"text-xs text-gray-500 mt-2 text-center",children:"Scannez ce QR dans l’app Orange Money pour finaliser."})]}),W&&e.jsxs(N,{onClick:()=>window.location.href=W,pill:!0,className:"rounded-lg px-5 py-2.5 font-medium w-full bg-orange-600 hover:bg-orange-700 text-white",children:["Ouvrir Orange Money ",e.jsx(B,{className:"ml-2 inline h-4 w-4"})]})]}),l==="wave"&&V&&e.jsxs(N,{onClick:()=>window.location.href=V,pill:!0,className:"rounded-lg px-5 py-2.5 font-medium w-full bg-blue-600 hover:bg-blue-700 text-white",children:["Ouvrir Wave ",e.jsx(B,{className:"ml-2 inline h-4 w-4"})]}),e.jsx("div",{className:"flex max-sm:flex-col items-center gap-4",children:e.jsx(N,{onClick:ne,disabled:j||E,pill:!0,className:"rounded-lg px-5 py-2.5 font-medium w-full bg-green-600 hover:bg-green-700 text-white text-xl",children:j?e.jsxs(e.Fragment,{children:[e.jsx(q,{className:"mr-2 h-4 w-4 animate-spin"}),e.jsx("p",{children:"Vérification..."})]}):E?"Vérification automatique en cours…":"Vérifier le paiement"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mt-6 mb-4",children:[e.jsx("h4",{className:"text-gray-800 font-medium mb-3",children:"Choisissez votre méthode de paiement"}),e.jsxs("div",{className:"flex space-x-4",children:[e.jsx("div",{className:`flex-1 border rounded-lg p-4 cursor-pointer transition-all ${l==="wave"?"border-blue-500 bg-blue-50":"border-gray-300 hover:border-blue-300"}`,onClick:()=>z("wave"),children:e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx("img",{src:ue,width:100,alt:""})})}),e.jsx("div",{className:`flex-1 border rounded-lg p-4 cursor-pointer transition-all ${l==="orange"?"border-orange-500 bg-orange-50":"border-gray-300 hover:border-orange-300"}`,onClick:()=>z("orange"),children:e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx("img",{src:xe,width:100,alt:""})})})]})]}),l&&e.jsxs("div",{className:"mt-4 mb-6",children:[e.jsxs("label",{htmlFor:"phone",className:"block text-sm font-medium text-gray-700 mb-1",children:["Numéro ",l==="wave"?"Wave":"Orange Money"]}),e.jsx("input",{type:"tel",id:"phone",value:w,onChange:r=>R(r.target.value),placeholder:"77 123 45 67",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Utilisez un numéro sénégalais (ex: 221771234567). 77/78/76/75/70 acceptés."})]}),e.jsx("div",{className:"flex max-sm:flex-col items-center gap-4 mt-8",children:e.jsx(N,{onClick:ae,disabled:j||!l||!w,pill:!0,className:"rounded-lg px-5 py-2.5 font-medium w-full hover:bg-red-500 hover:text-white text-xl",children:j?e.jsxs(e.Fragment,{children:[e.jsx(q,{className:"mr-2 h-4 w-4 animate-spin"}),e.jsx("p",{children:"Traitement en cours..."})]}):"Payer maintenant"})})]})]})})]})})})]})};export{Ne as W};
