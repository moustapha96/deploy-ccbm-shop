var M=(t,l,a)=>new Promise((b,j)=>{var p=i=>{try{d(a.next(i))}catch(o){j(o)}},N=i=>{try{d(a.throw(i))}catch(o){j(o)}},d=i=>i.done?b(i.value):Promise.resolve(i.value).then(p,N);d((a=a.apply(t,l)).next())});import{u as k,I as D,B as P,f as n,j as e,l as B,m as $,A as z,n as L,D as I,T as O,t as S}from"./index-B2FoVRhR.js";import{m as R,b as m}from"./vendor-KAqkdx26.js";import{f as V}from"./date-format-qL-o8H-f.js";import{P as W}from"./paimentService-DCdf-zyL.js";import{W as H}from"./wave-orange-payment-service-g3pF9T9g.js";function ee(){const{id:t}=R(),{user:l}=k(),[a,b]=m.useState(null),[j,p]=m.useState(!0),[N,d]=m.useState(!1),[i,o]=m.useState(0),[y,s]=m.useState(""),[A,u]=m.useState(!0),q=m.useCallback(()=>M(null,null,function*(){try{p(!0);const r=yield D.getCommandeById(l.id,t);b(r)}catch(r){console.error("Erreur lors de la récupération des données de la commande",r),P.error("Erreur lors de la récupération des données de la commande")}finally{p(!1)}}),[l.id,t]);m.useEffect(()=>{q()},[q]);const h=m.useMemo(()=>String(a&&a.type_sale||"").toLowerCase()==="order",[a&&a.type_sale]),C=m.useMemo(()=>Array.isArray(a&&a.payment_lines)?a.payment_lines:null,[a]),g=m.useMemo(()=>C&&(C.find(r=>r.sequence===1)||C[0])||null,[C]),w=m.useMemo(()=>g?!g.state:!1,[g]),c=m.useMemo(()=>{const r=Number(a&&a.amount_residual||0);return h?r>0?50:0:(a&&a.payment_mode)==="echelonne"?w&&g?Math.max(0,Number(g.amount)||0):r<=0?0:Math.min(Math.max(1e3,0),r):1e3},[a&&a.amount_residual,a&&a.payment_mode,h,w,g]);m.useEffect(()=>{if(a){if(h){o(c),s("");return}a.payment_mode==="echelonne"?(o(c),s("")):a.payment_mode==="online"?(o(Number(a.amount_total||0)),s("")):(o(0),s(""))}},[a,c,h]);const E=(r,x)=>{r.preventDefault();const _=Number(a&&a.amount_residual||0),v=Number(x||0);if(h){if(_<=0){P.info("Aucun montant restant à payer.");return}if(v<=0){s("Le montant doit être > 0.");return}if(v>_){s("Le montant ne doit pas dépasser le montant restant à payer.");return}s(""),d(!0);return}if(a.payment_mode==="echelonne"){if(_<=0){P.info("Aucun montant restant à payer.");return}if(w){if(v!==Number(c)){s(`Le montant doit être exactement l'acompte requis (${n(c)}).`);return}}else if(v<Number(c)){s(`Le montant doit être ≥ ${n(c)}.`);return}if(v>_){s("Le montant à payer ne doit pas dépasser le montant restant à payer");return}s(""),d(!0);return}if(a.payment_mode==="online"){if(v<1e3){s("Le montant minimum est de 1000 FCFA");return}if(v!==Number(a.amount_total||0)){s("Le montant à payer doit correspondre au total de la commande");return}s(""),d(!0);return}if(a.payment_mode==="domicile"){P.info("Le paiement se fera à domicile.");return}},F=r=>M(null,null,function*(){p(!0);try{yield W.createCommandePaiment(a.id),P.success("Paiement validé avec succès"),window.location.reload()}catch(x){console.error("Erreur lors de la création du paiement :",x),P.error("Erreur lors de la création du paiement")}finally{p(!1)}});return m.useEffect(()=>{if(!a)return;const r=Number(a&&a.amount_residual||0),x=Number(i||0);if(h){if(r<=0){u(!0);return}if(x<=0){s("Le montant doit être > 0."),u(!0);return}if(x>r){s("Le montant ne doit pas dépasser le montant restant à payer."),u(!0);return}s(""),u(!1);return}if(a.payment_mode==="echelonne"){if(r<=0){u(!0);return}if(w){const _=x===Number(c);u(!_),s(_?"":`Le montant doit être exactement l'acompte requis (${n(c)}).`);return}else{if(x<Number(c)){s(`Le montant doit être ≥ ${n(c)}.`),u(!0);return}if(x>r){s("Le montant à payer ne doit pas dépasser le montant restant à payer"),u(!0);return}s(""),u(!1);return}}if(a.payment_mode==="online"){x<1e3?(s("Le montant minimum est de 1000 FCFA"),u(!0)):x!==Number(a.amount_total||0)?(s("Le montant à payer doit correspondre au total de la commande"),u(!0)):(s(""),u(!1));return}u(!0)},[a,i,w,c,h]),e.jsxs(e.Fragment,{children:[e.jsx(B,{title:"CCBM Shop | Détails commande",description:"Consultez les détails de votre commande sur CCBM Shop, votre destination pour l'électroménager de qualité.",keywords:"détails commande, CCBM Shop, ccbme, suivi commande, paiement électroménager"}),e.jsx($,{childrenClasses:"pt-0 pb-0",children:e.jsxs("div",{className:"checkout-page-wrapper w-full bg-white pb-[60px]",children:[e.jsx("div",{className:"w-full mb-5",children:e.jsx(z,{title:"Détails Commande",breadcrumb:[{name:"Accueil",path:"/"},{name:"Commandes",path:"/profile#order"},{name:"Détails Commande"}]})}),j?e.jsx(e.Fragment,{children:e.jsxs("div",{className:"flex justify-center items-center h-screen",children:[e.jsx(L,{className:"animate-spin mr-2",size:48}),e.jsx("span",{className:"text-lg",children:"Chargement de la commande..."})]})}):e.jsx("div",{className:"checkout-main-content w-full",children:e.jsxs("div",{className:"container-x mx-auto",children:[e.jsx(T,{commande:a}),e.jsx(G,{commande:a}),e.jsx(J,{commande:a,montantAPayer:i,setMontantAPayer:o,errorMontantAPayer:y,stateButton:A,isLoading:j,validerPaiment:E,minAmountToPay:c,acompteDue:w,isTypeOrder:h}),N&&a&&e.jsx(H,{handlePay:F,totalAmount:i,onClose:()=>d(!1),order:a,idOrder:a.id})]})})]})})]})}const T=({commande:t})=>e.jsxs("div",{className:"w-full sm:mb-10 mb-5",children:[e.jsxs("div",{className:"sm:flex sm:space-x-[18px]",children:[e.jsx(f,{label:"N°Commande",value:t.name}),t.payment_mode==="domicile"&&e.jsx(f,{label:"Paiement",value:t.advance_payment_status==="not_paid"?"A domicile":"Non Payé",className:t.advance_payment_status==="not_paid"?"text-red-500":"text-green-500"}),t.payment_mode==="online"&&e.jsx(f,{label:"Paiement",value:t.advance_payment_status==="not_paid"?"Non Payé":"Payé",className:t.advance_payment_status==="not_paid"?"text-red-500":"text-green-500"}),t.payment_mode==="echelonne"&&e.jsx(f,{label:"Paiement",value:t.advance_payment_status==="not_paid"?"Non Payé":t.advance_payment_status==="paid"?"Payé":"Partiellement Payé",className:t.advance_payment_status==="not_paid"?"text-red-500":t.advance_payment_status==="paid"?"text-green-500":t.advance_payment_status==="partial"?"text-yellow-500":""}),e.jsx(f,{label:"Statut",value:t.state==="sale"?"Validée":t.state==="to_delivered"?"En cours de livraison":t.state==="delivered"?"Livrée":"Non validé",className:t.state==="sale"?"text-green-500":t.state==="to_delivered"?"text-yellow-500":t.state==="delivered"?"text-green-600":"text-gray-500"})]}),t.payment_mode==="echelonne"&&e.jsxs("div",{className:"sm:flex sm:space-x-[18px] mt-5",children:[e.jsx(f,{label:"Montant Restant",value:`${n(t.amount_residual)}`}),e.jsx(f,{label:"Montant Total",value:["not_paid","paid"].includes(t.advance_payment_status)?e.jsx("span",{className:`text-${t.advance_payment_status==="not_paid"?"red":"green"}-500`,children:n(t.amount_total)}):e.jsxs(e.Fragment,{children:[" ",n(t.amount_total)]})}),e.jsx(f,{label:"Montant Avancé",value:n(t.amount_total-t.amount_residual)})]}),e.jsxs("div",{className:"sm:flex sm:space-x-[18px] mt-5",children:[e.jsx(f,{label:"Mode de Paiement",value:t.payment_mode==="online"?"En ligne":t.payment_mode==="domicile"?"A domicile":"Echelonné"}),e.jsx(f,{label:"Date de livraison",value:V(t.commitment_date)})]})]}),G=({commande:t})=>e.jsxs("div",{className:"w-full max-w-4xl mx-auto px-4 sm:px-6 lg:px-8",children:[e.jsx("h1",{className:"sm:text-2xl text-xl text-qblack font-medium mb-5",children:"Récapitulatif de la commande"}),e.jsxs("div",{className:"w-full p-4 sm:p-6 border border-[#EDEDED] rounded-lg shadow-sm",children:[e.jsx("div",{className:"sub-total mb-6",children:e.jsxs("div",{className:"flex justify-between mb-5",children:[e.jsx("p",{className:"text-[13px] font-medium text-qblack uppercase",children:"Produit"}),t.type_order==="commande"&&e.jsx("p",{className:"text-[13px] font-medium text-qblack uppercase",children:"Total"})]})}),e.jsx("div",{className:"product-list w-full mb-[30px]",children:e.jsx("ul",{className:"flex flex-col space-y-5",children:t.order_lines.map((l,a)=>e.jsx("li",{children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsxs("h4",{className:"text-[15px] text-qblack mb-2.5",children:[l.product_name,e.jsx("sup",{className:"text-[13px] text-qgray ml-2 mt-2",children:t.type_order==="commande"&&e.jsxs("span",{children:[" = ",l.product_uom_qty," x ",n(l.price_total)]})})]}),e.jsx("p",{className:"text-[13px] text-qgray",children:l.description})]}),e.jsx("div",{children:t.type_order==="commande"&&e.jsx("span",{className:"text-[15px] text-qblack font-medium",children:n(l.price_total)})})]})},a))})}),e.jsx("div",{className:"mt-[30px]",children:e.jsxs("div",{className:"flex justify-between mb-5",children:[e.jsx("p",{className:"text-2xl font-medium text-qblack",children:"Total"}),e.jsx("p",{className:"text-2xl font-medium",children:["not_paid","paid"].includes(t.advance_payment_status)&&e.jsx("span",{className:`text-${t.advance_payment_status==="not_paid"?"red":"green"}-500`,children:n(t.amount_total)})})]})})]})]}),J=({commande:t,montantAPayer:l,setMontantAPayer:a,errorMontantAPayer:b,stateButton:j,isLoading:p,validerPaiment:N,minAmountToPay:d,acompteDue:i,isTypeOrder:o})=>e.jsx("div",{className:"w-full max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 mt-8",children:t.advance_payment_status==="not_paid"||t.advance_payment_status==="partial"?e.jsxs(e.Fragment,{children:[t.payment_mode==="domicile"&&e.jsx("div",{className:"flex justify-center items-center mt-2",children:e.jsx("span",{className:"text-lg font-medium text-red-500 dark:text-white",children:"Le paiement se fera à domicile"})}),(t.payment_mode==="echelonne"||o)&&e.jsxs("div",{children:[e.jsxs("div",{className:"input-item mb-5",children:[e.jsx("div",{className:"mb-2 inline-block",children:e.jsx(I,{htmlFor:"montant",value:"Montant à payer"})}),e.jsx(O,{id:"montant",placeholder:o?"Montant libre (> 0)":i?`Acompte requis: ${n(d)}`:"Minimum 1000 F CFA",label:"Montant*",name:"montantAPayer",type:"number",value:l,onChange:y=>a(y.target.value),max:t.amount_residual,min:o?1:i?Number(d):0,required:!0,className:"invalid:border-red-500 invalid:text-red-600 focus:invalid:border-red-500 focus:invalid:ring-red-500"}),b&&e.jsx("p",{className:"text-yellow-500",children:b})]}),e.jsxs(S,{type:"submit",onClick:y=>N(y,l),className:"rounded-lg px-5 py-2.5 font-medium w-full hover:bg-red-500 hover:text-white text-xl",disabled:j,children:[p&&e.jsx(L,{className:"mr-2 h-4 w-4 animate-spin"}),"Passer à la caisse (",n(l),")"]}),e.jsx("p",{className:"mt-2 text-xs text-gray-500 text-center",children:o?e.jsxs(e.Fragment,{children:["Paiement libre : choisissez le montant que vous souhaitez (strictement > 0), jusqu’à ",e.jsx("strong",{children:n(t.amount_residual)})," restant."]}):i?e.jsxs(e.Fragment,{children:["Acompte requis : ",e.jsx("strong",{children:n(d)}),". Vous devrez solder l’acompte avant de pouvoir payer librement."]}):e.jsxs(e.Fragment,{children:["Paiement libre : choisissez le montant que vous souhaitez (minimum ",e.jsx("strong",{children:n(Math.max(1e3,Number(d)||0))}),"), jusqu’à ",e.jsx("strong",{children:n(t.amount_residual)})," restant."]})})]}),t.payment_mode==="online"&&!o&&e.jsxs(S,{type:"submit",onClick:y=>N(y,t.amount_total),className:"rounded-lg px-5 py-2.5 font-medium w-full hover:bg-red-500 hover:text-white text-xl",disabled:p,children:[p&&e.jsx(L,{className:"mr-2 h-4 w-4 animate-spin"}),"Passer à la caisse (",n(t.amount_total),")"]})]}):e.jsx("div",{className:"w-full h-[50px] flex justify-center items-center",children:e.jsx("span",{className:"text-green-500",children:"Le paiement a été effectué avec succès"})})}),f=({label:t,value:l,className:a=""})=>e.jsx("div",{className:"sm:w-1/3 w-full mb-5 h-[70px]",children:e.jsx("div",{className:"w-full h-full bg-[#F6F6F6] text-qblack flex justify-center items-center",children:e.jsxs("span",{className:"text-[15px] font-medium",children:[t,"  : ",e.jsx("span",{className:a,children:l})]})})});export{ee as default};
